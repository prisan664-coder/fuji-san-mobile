<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventory - Fuji Mobile Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f6f7fb
        }

        .container-lg {
            padding-top: 24px
        }

        .card-inv {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(20, 20, 50, 0.06)
        }

        .low-stock {
            background: #ffe9e9
        }

        .normal-stock {
            background: #f3fff6
        }

        .table-fixed tbody {
            height: 520px;
            overflow: auto
        }

        .search-input {
            max-width: 420px
        }

        .mini {
            font-size: 0.85rem
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand nav-brand" href="index.html">Fuji Mobile Shop</a>
            <div class="ms-auto">
                <a class="btn btn-outline-secondary" href="record_sale.html">บันทึกขาย</a>
            </div>
        </div>
    </nav>

    <main class="container-lg">
        <div class="card card-inv p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Inventory</h4>
                <div class="d-flex gap-2 align-items-center">
                    <input id="search" class="form-control search-input" placeholder="ค้นหา รุ่น / ชื่อ ...">
                    <button class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#modalAdd">เพิ่มสินค้า</button>
                    <!-- ปุ่มดาวน์โหลด Excel -->
                    <button id="downloadExcel" class="btn btn-success">ดาวน์โหลด Excel</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Model ID</th>
                            <th>ชื่อ (Model)</th>
                            <th>ราคาทุน (Kip)</th>
                            <th>ราคาขาย (Kip)</th>
                            <th>จำนวนคงเหลือ</th>
                            <th>Min Stock</th>
                            <th>สถานะ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <!-- rows from firebase -->
                    </tbody>
                </table>
            </div>

        </div>
    </main>

    <!-- Modal add/edit -->
    <div class="modal fade" id="modalAdd" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="modalTitle" class="modal-title">เพิ่มสินค้าใหม่</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Model ID (ไม่ซ้ำ)</label>
                                <input id="modelId" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ชื่อสินค้า</label>
                                <input id="name" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ราคาทุน (Kip)</label>
                                <input id="cost" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ราคาขาย (Kip)</label>
                                <input id="sell_price" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">จำนวนคงเหลือ</label>
                                <input id="stock_now" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Min Stock</label>
                                <input id="min_stock" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea id="note" class="form-control mini" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button id="saveBtn" class="btn btn-primary">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS CDN -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase + App JS (module) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
        import { getDatabase, ref, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js'

        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            databaseURL: "https://fuji-mobile-shop-default-rtdb.asia-southeast1.firebasedatabase.app/"
        }

        const app = initializeApp(firebaseConfig)
        const db = getDatabase(app)
        const productsRef = ref(db, 'products')

        const productsBody = document.getElementById('productsBody')
        const searchInput = document.getElementById('search')

        let lastData = {}

        onValue(productsRef, (snap) => { lastData = snap.val() || {}; renderTable(lastData) })

        function renderTable(data) {
            const q = searchInput.value.trim().toLowerCase()
            productsBody.innerHTML = ''
            const keys = Object.keys(data).sort()
            for (const k of keys) {
                const p = data[k]
                const text = (k + ' ' + (p.name || '')).toLowerCase()
                if (q && !text.includes(q)) continue

                const tr = document.createElement('tr')
                const statusClass = (Number(p.stock_now) <= Number(p.min_stock)) ? 'low-stock' : 'normal-stock'
                tr.innerHTML = `
                    <td class="fw-bold">${k}</td>
                    <td>${escapeHtml(p.name || '')}</td>
                    <td>${formatNum(p.cost)}</td>
                    <td>${formatNum(p.sell_price)}</td>
                    <td>${Number(p.stock_now)}</td>
                    <td>${Number(p.min_stock)}</td>
                    <td class="mini">${Number(p.stock_now) <= Number(p.min_stock) ? '<span class="badge bg-danger">Low</span>' : '<span class="badge bg-success">OK</span>'}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${k}')">แก้ไข</button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${k}')">ลบ</button>
                    </td>`
                tr.className = statusClass
                productsBody.appendChild(tr)
            }
        }

        function escapeHtml(s) { return String(s || '').replace(/[&<>\"]+/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" })[m] || m) }
        function formatNum(n) { if (n == null || n === '') return ''; return Number(n).toLocaleString('en-US') }

        searchInput.addEventListener('input', () => { renderTable(lastData) })

        const productForm = document.getElementById('productForm')
        const modalTitle = document.getElementById('modalTitle')
        const productIdInput = document.getElementById('productId')
        const modelIdInput = document.getElementById('modelId')
        const nameInput = document.getElementById('name')
        const costInput = document.getElementById('cost')
        const sellInput = document.getElementById('sell_price')
        const stockInput = document.getElementById('stock_now')
        const minInput = document.getElementById('min_stock')
        const noteInput = document.getElementById('note')
        const saveBtn = document.getElementById('saveBtn')

        saveBtn.addEventListener('click', async () => {
            const id = modelIdInput.value.trim()
            if (!id) { alert('กรุณาใส่ Model ID'); return }
            const payload = {
                name: nameInput.value.trim(),
                cost: Number(costInput.value) || 0,
                sell_price: Number(sellInput.value) || 0,
                stock_now: Number(stockInput.value) || 0,
                min_stock: Number(minInput.value) || 0,
                note: noteInput.value.trim()
            }
            const editing = productIdInput.value
            if (editing) {
                if (editing !== id) { await set(ref(db, `products/${id}`), payload); await remove(ref(db, `products/${editing}`)) }
                else { await update(ref(db, `products/${id}`), payload) }
            } else {
                const exists = lastData && lastData[id]
                if (exists) { if (!confirm('Model ID นี้มีอยู่แล้ว ต้องการแทนที่หรือไม่?')) return }
                await set(ref(db, `products/${id}`), payload)
            }
            productForm.reset()
            productIdInput.value = ''
            const modalEl = document.querySelector('#modalAdd')
            const modal = bootstrap.Modal.getInstance(modalEl)
            modal.hide()
        })

        window.editProduct = function (id) {
            const p = lastData[id]
            if (!p) return alert('ไม่พบข้อมูล')
            productIdInput.value = id
            modelIdInput.value = id
            nameInput.value = p.name || ''
            costInput.value = p.cost || 0
            sellInput.value = p.sell_price || 0
            stockInput.value = p.stock_now || 0
            minInput.value = p.min_stock || 0
            noteInput.value = p.note || ''
            modalTitle.innerText = 'แก้ไขสินค้า'
            const modal = new bootstrap.Modal(document.getElementById('modalAdd'))
            modal.show()
        }

        window.deleteProduct = async function (id) {
            if (!confirm('ต้องการลบสินค้ารายการนี้ใช่หรือไม่?')) return
            await remove(ref(db, `products/${id}`))
        }

        // ====== ฟังก์ชันดาวน์โหลด Excel ======
        document.getElementById('downloadExcel').addEventListener('click', () => {
            const ws_data = [['Model ID', 'ชื่อ (Model)', 'ราคาทุน', 'ราคาขาย', 'จำนวนคงเหลือ', 'Min Stock', 'สถานะ']]
            Object.keys(lastData).sort().forEach(id => {
                const p = lastData[id]
                ws_data.push([
                    id,
                    p.name || '',
                    p.cost || 0,
                    p.sell_price || 0,
                    p.stock_now || 0,
                    p.min_stock || 0,
                    p.stock_now <= p.min_stock ? 'Low' : 'OK'
                ])
            })
            const wb = XLSX.utils.book_new()
            const ws = XLSX.utils.aoa_to_sheet(ws_data)
            XLSX.utils.book_append_sheet(wb, ws, 'Inventory')
            XLSX.writeFile(wb, 'Inventory.xlsx')
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
