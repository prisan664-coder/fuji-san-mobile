<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventory - Fuji Mobile Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f6f7fb;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: #121212;
            color: #f1f1f1;
        }

        .card-inv {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(20, 20, 50, 0.06);
            padding: 20px;
            margin-top: 20px;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode .card-inv {
            background: #1e1e1e;
            color: #f1f1f1;
        }

        .low-stock {
            background: #ffe9e9;
        }

        body.dark-mode .low-stock {
            background: #721c24;
            color: #fff;
        }

        .normal-stock {
            background: #f3fff6;
        }

        body.dark-mode .normal-stock {
            background: #155724;
            color: #fff;
        }

        .search-input {
            max-width: 400px;
        }

        .badge-low {
            background-color: #dc3545;
        }

        .badge-ok {
            background-color: #28a745;
        }

        .table-fixed tbody {
            display: block;
            height: 450px;
            overflow-y: auto;
        }

        .table-fixed thead,
        .table-fixed tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">Fuji Mobile Shop</a>
            <div class="ms-auto">
                <button id="toggleDark" class="btn btn-outline-secondary me-2">Dark / Light Mode</button>
                <a class="btn btn-outline-secondary" href="record_sale.html">Record Sale</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="card-inv">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Inventory</h4>
                <input id="search" class="form-control search-input" placeholder="ค้นหา Model หรือ ชื่อ...">
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-fixed">
                    <thead class="table-light">
                        <tr>
                            <th>Model ID</th>
                            <th>ชื่อ (Model)</th>
                            <th>ราคาทุน (Kip)</th>
                            <th>ราคาขาย (Kip)</th>
                            <th>จำนวนคงเหลือ</th>
                            <th>Min Stock</th>
                            <th>สถานะ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody"></tbody>
                </table>
            </div>
            <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                data-bs-target="#modalAdd">เพิ่มสินค้าใหม่</button>
        </div>
    </div>

    <!-- Modal Add/Edit -->
    <div class="modal fade" id="modalAdd" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="modalTitle" class="modal-title">เพิ่มสินค้าใหม่</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Model ID (ไม่ซ้ำ)</label>
                                <input id="modelId" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ชื่อสินค้า</label>
                                <input id="name" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ราคาทุน (Kip)</label>
                                <input id="cost" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ราคาขาย (Kip)</label>
                                <input id="sell_price" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">จำนวนคงเหลือ</label>
                                <input id="stock_now" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Min Stock</label>
                                <input id="min_stock" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">หมายเหตุ</label>
                                <textarea id="note" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button id="saveBtn" class="btn btn-primary">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            databaseURL: "https://fuji-mobile-shop-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'products');

        const productsBody = document.getElementById('productsBody');
        const searchInput = document.getElementById('search');
        let lastData = {};

        onValue(productsRef, snapshot => {
            lastData = snapshot.val() || {};
            renderTable(lastData);
        });

        searchInput.addEventListener('input', () => { renderTable(lastData); });

        function renderTable(data) {
            productsBody.innerHTML = '';
            const q = searchInput.value.toLowerCase();
            Object.keys(data).sort().forEach(k => {
                const p = data[k];
                const text = (k + ' ' + (p.name || '')).toLowerCase();
                if (q && !text.includes(q)) return;
                const tr = document.createElement('tr');
                const statusClass = (Number(p.stock_now) <= Number(p.min_stock)) ? 'low-stock' : 'normal-stock';
                tr.className = statusClass;
                tr.innerHTML = `
      <td>${k}</td>
      <td>${p.name || ''}</td>
      <td>${Number(p.cost).toLocaleString()}</td>
      <td>${Number(p.sell_price).toLocaleString()}</td>
      <td>${p.stock_now}</td>
      <td>${p.min_stock}</td>
      <td>${Number(p.stock_now) <= Number(p.min_stock) ? '<span class="badge badge-low">Low</span>' : '<span class="badge badge-ok">OK</span>'}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${k}')">แก้ไข</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${k}')">ลบ</button>
      </td>
    `;
                productsBody.appendChild(tr);
            });
        }

        const productForm = document.getElementById('productForm');
        const modalTitle = document.getElementById('modalTitle');
        const productIdInput = document.getElementById('productId');
        const saveBtn = document.getElementById('saveBtn');

        saveBtn.addEventListener('click', async () => {
            const id = document.getElementById('modelId').value.trim();
            if (!id) return alert('กรุณาใส่ Model ID');
            const payload = {
                name: document.getElementById('name').value.trim(),
                cost: Number(document.getElementById('cost').value) || 0,
                sell_price: Number(document.getElementById('sell_price').value) || 0,
                stock_now: Number(document.getElementById('stock_now').value) || 0,
                min_stock: Number(document.getElementById('min_stock').value) || 0,
                note: document.getElementById('note').value.trim()
            };
            const editing = productIdInput.value;
            if (editing) {
                if (editing !== id) {
                    await set(ref(db, `products/${id}`), payload);
                    await remove(ref(db, `products/${editing}`));
                } else {
                    await update(ref(db, `products/${id}`), payload);
                }
            } else {
                await set(ref(db, `products/${id}`), payload);
            }
            productForm.reset();
            productIdInput.value = '';
            const modalEl = document.getElementById('modalAdd');
            bootstrap.Modal.getInstance(modalEl).hide();
        });

        window.editProduct = function (id) {
            const p = lastData[id];
            if (!p) return alert('ไม่พบข้อมูล');
            productIdInput.value = id;
            document.getElementById('modelId').value = id;
            document.getElementById('name').value = p.name || '';
            document.getElementById('cost').value = p.cost || 0;
            document.getElementById('sell_price').value = p.sell_price || 0;
            document.getElementById('stock_now').value = p.stock_now || 0;
            document.getElementById('min_stock').value = p.min_stock || 0;
            document.getElementById('note').value = p.note || '';
            modalTitle.innerText = 'แก้ไขสินค้า';
            new bootstrap.Modal(document.getElementById('modalAdd')).show();
        }

        window.deleteProduct = async function (id) {
            if (confirm('ต้องการลบสินค้ารายการนี้ใช่หรือไม่?')) {
                await remove(ref(db, `products/${id}`));
            }
        }

        // Dark/Light mode toggle
        const toggleBtn = document.getElementById('toggleDark');
        toggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>