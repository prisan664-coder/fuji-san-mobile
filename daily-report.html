<!DOCTYPE html>
<html lang="lo">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡ªÄ‡∫ö‡∫±‡ªà‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∑‡∫Å‡∫ä‡∫µ‡∫ß‡∫¥‡∫î WYSIWYG - Docu Note</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f0f0f0;
            padding: 0;
            margin: 0;
        }

        nav {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        nav h2 {
            margin: 0;
            font-size: 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 5px;
            background: #1976D2;
            transition: background 0.3s;
        }

        nav a:hover {
            background: #1565C0;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
        }

        #noteForm,
        #filterForm {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto 20px auto;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #noteForm input,
        #filterForm input {
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }

        #editor {
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #fff;
            overflow: auto;
        }

        button {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        button.save {
            background: #4CAF50;
            color: white;
        }

        button.update {
            background: #2196F3;
            color: white;
            display: none;
        }

        button.filter {
            background: #ff9800;
            color: white;
        }

        .note-day {
            max-width: 800px;
            margin: 10px auto;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
        }

        .note-day h3 {
            margin: 0 0 10px 0;
            background: #f4f4f4;
            padding: 5px 10px;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f9f9f9;
        }

        td button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
        }

        td button.edit {
            background: #2196F3;
            color: white;
        }

        td button.delete {
            background: #f44336;
            color: white;
        }

        td button.view {
            background: #FF9800;
            color: white;
        }

        .toolbar {
            display: flex;
            margin-bottom: 5px;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 5px 10px;
            font-size: 14px;
        }

        /* üí° CSS ‡ªÉ‡ªù‡ªà‡∫™‡∫≥‡∫•‡∫±‡∫ö Emoji Picker */
        .toolbar button.emoji-btn {
            background: #e0e0e0;
            color: #333;
            font-size: 16px;
        }

        .emoji-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-list span {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .emoji-list span:hover {
            transform: scale(1.2);
        }

        /* End new CSS */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            text-align: center;
        }

        /* üí° ‡∫õ‡∫±‡∫ö‡∫Ç‡∫∞‡ªú‡∫≤‡∫î Modal ‡∫™‡ªç‡∫≤‡∫•‡∫±‡∫ö Emoji */
        #emojiModal .modal-content {
            max-width: 500px;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .modal-close {
            float: right;
            font-size: 20px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal button {
            margin: 10px;
        }

        .modal button.confirm {
            background: #f44336;
            color: white;
        }

        .modal button.cancel {
            background: #9e9e9e;
            color: white;
        }

        #shareLinkContainer {
            margin-top: 10px;
            word-break: break-all;
            text-align: center;
            background: #f4f4f4;
            padding: 5px;
            border-radius: 5px;
        }

        body *:not(#editor):not(.toolbar):not(nav):not(#filterForm):not(.modal):not(.modal *) {
            user-select: none;
        }
    </style>
</head>

<body>
    <nav>
        <h2>Docu Note</h2>
        <a href="note.html">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç‡∫õ‡∫∞‡∫à‡∫≥‡∫ß‡∫±‡∫ô</a>
    </nav>

    <h1>‡∫ö‡∫ª‡∫î‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ä‡∫µ‡∫ß‡∫¥‡∫î‡ªÅ‡∫•‡∫∞‡ªÅ‡∫ö‡ªà‡∫á‡∫ö‡∫±‡∫ô‡∫õ‡∫∞‡∫™‡∫ª‡∫ö‡∫Å‡∫≤‡∫ô</h1>

    <div id="noteForm">
        <input type="text" id="noteTitle" placeholder="‡ªÄ‡∫´‡∫ª‡∫≤‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ">
        <div class="toolbar">
            <button type="button" onclick="execCmd('bold')"><b>B</b></button>
            <button type="button" onclick="execCmd('italic')"><i>I</i></button>
            <button type="button" onclick="execCmd('underline')"><u>U</u></button>
            <button type="button" onclick="execCmd('foreColor','red')">‡ªÅ‡∫î‡∫á</button>
            <button type="button" onclick="execCmd('foreColor','green')">‡∫Ç‡∫Ω‡∫ß</button>
            <button type="button" onclick="execCmd('insertOrderedList')">OL</button>
            <button type="button" onclick="execCmd('insertUnorderedList')">UL</button>
            <button type="button" onclick="execCmd('createLink',prompt('‡∫õ‡ªâ‡∫≠‡∫ô URL'))">Link</button>
            <button type="button" onclick="wrapSelection('left')">‡∏ã‡πâ‡∏≤‡∏¢</button>
            <button type="button" onclick="wrapSelection('center')">‡∏Å‡∏•‡∏≤‡∏á</button>
            <button type="button" onclick="wrapSelection('right')">‡∏Ç‡∏ß‡∏≤</button>

            <button type="button" class="emoji-btn" onclick="openEmojiModal()">üòÄ Emoji</button>
        </div>
        <div id="editor" contenteditable="true"></div>
        <button class="save" onclick="saveNote()">‡∫ö‡∫±‡∫ô‡∫ó‡∫∑‡∫Å</button>
        <button class="update" onclick="updateNote()">‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>
    </div>

    <div id="filterForm">
        <input type="date" id="filterDate">
        <button class="filter" onclick="filterNotes()">‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ï‡∫≤‡∫°‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</button>
        <button class="filter" onclick="clearFilter()">‡∫™‡∫∞‡∫Å‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
        <button class="filter" onclick="downloadExcel()">‡∫î‡∫≤‡∫ß‡ªÇ‡∫ô‡ªâ‡∫î Excel</button>
    </div>

    <div id="notesContainer"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle"></h2>
            <div id="modalContent"></div>
            <button id="shareBtn" onclick="generateShareLink()">‡ªÅ‡∫ö‡ªà‡∫á‡∫õ‡∫±‡∫ô</button>
            <div id="shareLinkContainer"></div>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö</h2>
            <p>‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫ö‡∫±‡∫ô‡∫ó‡∫∑‡∫Å‡∫ô‡∫µ‡ªâ?</p>
            <button class="confirm" id="confirmDelete">‡∫•‡∫∂‡∫ö</button>
            <button class="cancel" onclick="closeDeleteModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
        </div>
    </div>

    <div id="emojiModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEmojiModal()">&times;</button>
            <h2>‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å Emoji</h2>
            <div id="emojiList" class="emoji-list">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8b0h8yyTo5th6UMvI4_dKUB1ZnvCwZBw",
            authDomain: "fuji-mobile-shop.firebaseapp.com",
            databaseURL: "https://fuji-mobile-shop-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fuji-mobile-shop",
            storageBucket: "fuji-mobile-shop.appspot.com",
            messagingSenderId: "753053073037",
            appId: "1:753053073037:web:7c9cb46e055b91a4cf2cc4",
            measurementId: "G-BZH3DRHBFV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let editKey = null;
        let deleteKey = null;
        let currentNoteId = null;
        let originalRange = null; // üí° ‡∫ï‡∫ª‡∫ß‡∫õ‡ªà‡∫Ω‡∫ô‡ªÉ‡ªù‡ªà‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÄ‡∫Å‡∫±‡∫ö‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á cursor

        const noteTitle = document.getElementById('noteTitle');
        const editor = document.getElementById('editor');
        const saveBtn = document.querySelector('#noteForm .save');
        const updateBtn = document.querySelector('#noteForm .update');
        const shareLinkContainer = document.getElementById('shareLinkContainer');
        const filterDateInput = document.getElementById('filterDate');

        window.execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); }

        function wrapSelection(alignment) {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            const selectedContent = range.extractContents();
            const wrapper = document.createElement('div');
            wrapper.style.textAlign = alignment;
            wrapper.appendChild(selectedContent);
            range.insertNode(wrapper);
            sel.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNodeContents(wrapper);
            sel.addRange(newRange);
        }
        window.wrapSelection = wrapSelection;

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        window.showModal = (title, content, id = null) => {
            modalTitle.innerHTML = title;
            modalContent.innerHTML = content;
            modal.style.display = 'block';
            shareLinkContainer.innerHTML = '';
            currentNoteId = id;
        }
        window.closeModal = () => { modal.style.display = 'none'; }

        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        window.closeDeleteModal = () => { deleteModal.style.display = 'none'; deleteKey = null; }

        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteKey) {
                remove(ref(db, 'notes/' + deleteKey))
                    .then(() => alert('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß!'))
                    .catch(err => console.error('Error deleting note:', err));
            }
            closeDeleteModal();
        });

        // üí° ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô Emoji
        const emojiModal = document.getElementById('emojiModal');
        const emojiListContainer = document.getElementById('emojiList');

        // üí° ‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà Emoji ‡∫ó‡∫µ‡ªà‡∫ô‡∫¥‡∫ç‡∫ª‡∫° (‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÑ‡∫î‡ªâ)
        const commonEmojis = [
            'üòÄ', 'üòÇ', 'üòç', 'ü§î', 'üòä', 'üò≠', 'üòé', 'ü•≥', 'ü§©', 'üëç',
            'üëé', '‚ù§Ô∏è', 'üíî', 'üåü', 'üî•', 'üéâ', 'üí°', '‚úÖ', '‚ùå', 'üìù',
            'üìÖ', '‚è∞', 'üí∞', 'üíº', 'üè°', 'üíª', 'üì±', 'üìö', 'üçï', '‚òï'
        ];

        // üí° ‡ªÄ‡∫û‡∫µ‡ªà‡∫° event listener ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á cursor ‡∫Å‡ªà‡∫≠‡∫ô‡ªÄ‡∫õ‡∫µ‡∫î modal
        editor.addEventListener('mouseup', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                originalRange = selection.getRangeAt(0);
            }
        });
        editor.addEventListener('keyup', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                originalRange = selection.getRangeAt(0);
            }
        });


        function renderEmojis() {
            emojiListContainer.innerHTML = '';
            commonEmojis.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = () => insertEmoji(emoji);
                emojiListContainer.appendChild(span);
            });
        }

        window.openEmojiModal = function () {
            // ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á cursor ‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                originalRange = selection.getRangeAt(0);
            }
            renderEmojis();
            emojiModal.style.display = 'block';
        }

        window.closeEmojiModal = function () {
            emojiModal.style.display = 'none';
            // üí° ‡∫ü‡∫∑‡ªâ‡∫ô‡∫ü‡∫π‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á cursor
            if (originalRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(originalRange);
                editor.focus();
            }
        }

        function insertEmoji(emoji) {
            closeEmojiModal();

            // üí° ‡∫ü‡∫∑‡ªâ‡∫ô‡∫ü‡∫π‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á cursor
            if (originalRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(originalRange);
                editor.focus();
            } else {
                editor.focus();
            }

            // ‡ªÉ‡∫ä‡ªâ document.execCommand('insertText') ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÉ‡∫™‡ªà Emoji
            document.execCommand('insertText', false, emoji);

            // üí° ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡ªÉ‡ªù‡ªà‡∫´‡∫º‡∫±‡∫á‡∫à‡∫≤‡∫Å‡ªÉ‡∫™‡ªà
            const selectionAfterInsert = window.getSelection();
            if (selectionAfterInsert.rangeCount > 0) {
                originalRange = selectionAfterInsert.getRangeAt(0);
            }

        }

        // ** (1) SAVE NOTE FUNCTION **
        window.saveNote = function () {
            const title = noteTitle.value.trim();
            const content = editor.innerHTML.trim();
            if (!title || !content) {
                alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ‡ªÅ‡∫•‡∫∞‡ªÄ‡∫ô‡∫∑‡ªâ‡∫≠‡∫´‡∫≤!');
                return;
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-CA').replace(/\//g, '-'); // Format YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].substring(0, 5); // Format HH:MM

            const newNote = {
                title: title,
                content: content,
                date: `${dateStr} ${timeStr}`
            };

            const newNoteRef = push(ref(db, 'notes'));
            set(newNoteRef, newNote)
                .then(() => {
                    alert('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!');
                    noteTitle.value = '';
                    editor.innerHTML = '';
                })
                .catch((error) => {
                    console.error("Error saving note: ", error);
                    alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å!');
                });
        }

        // ** (2) LOAD NOTES FUNCTION **
        function loadNotes() {
            onValue(ref(db, 'notes'), snap => renderNotes(snap.val()));
        }

        function renderNotes(data, filterDay = null) {
            const container = document.getElementById('notesContainer');
            container.innerHTML = '';
            if (!data) return;
            const grouped = {};
            Object.keys(data).forEach(key => {
                const note = data[key];
                const day = note.date.split(' ')[0];
                if (!grouped[day]) grouped[day] = [];
                grouped[day].push({ ...note, key });
            });
            Object.keys(grouped).sort((a, b) => b.localeCompare(a)).forEach(day => {
                if (filterDay && day !== filterDay) return;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'note-day';
                dayDiv.innerHTML = `<h3>${day}</h3>`;
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>‡ªÄ‡∫ß‡∫•‡∫≤</th><th>‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ</th><th>‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î</th><th>‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</th></tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                grouped[day].forEach(note => {
                    const tr = document.createElement('tr');
                    // ‡ªÉ‡∫ä‡ªâ escape function ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Æ‡∫±‡∫ö‡∫õ‡∫∞‡∫Å‡∫±‡∫ô‡∫ß‡ªà‡∫≤ data-title/data-content ‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á
                    const escapedTitle = note.title.replace(/"/g, '&quot;');
                    const escapedContent = note.content.replace(/"/g, '&quot;');
                    tr.innerHTML = `<td>${note.date.split(' ')[1]}</td>
            <td>${escapedTitle}</td>
            <td><button class="view" data-title="${escapedTitle}" data-content="${escapedContent}" data-id="${note.key}">‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î</button></td>
            <td><button class="edit" onclick="editNote('${note.key}')">‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>
            <button class="delete" onclick="promptDelete('${note.key}')">‡∫•‡∫∂‡∫ö</button></td>`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                dayDiv.appendChild(table);
                container.appendChild(dayDiv);
            });
            document.querySelectorAll('.view').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å escape ‡∫°‡∫≤‡∫™‡∫∞‡ªÅ‡∫î‡∫á
                    const title = btn.dataset.title;
                    const content = btn.dataset.content;
                    const id = btn.dataset.id;
                    showModal(title, content, id);
                });
            });
        }

        // ** (3) EDIT NOTE FUNCTION **
        window.editNote = function (key) {
            editKey = key;
            saveBtn.style.display = 'none';
            updateBtn.style.display = 'block';

            get(ref(db, 'notes/' + key)).then((snapshot) => {
                if (snapshot.exists()) {
                    const note = snapshot.val();
                    noteTitle.value = note.title;
                    editor.innerHTML = note.content;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫à‡∫∞‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç.');
                    resetForm();
                }
            }).catch(error => {
                console.error("Error reading note for edit: ", error);
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô.');
                resetForm();
            });
        }

        // ** (4) UPDATE NOTE FUNCTION **
        window.updateNote = function () {
            if (!editKey) return;

            const title = noteTitle.value.trim();
            const content = editor.innerHTML.trim();
            if (!title || !content) {
                alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ‡ªÅ‡∫•‡∫∞‡ªÄ‡∫ô‡∫∑‡ªâ‡∫≠‡∫´‡∫≤!');
                return;
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-CA').replace(/\//g, '-');
            const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);

            const updatedNote = {
                title: title,
                content: content,
                // ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î‡ªÄ‡∫ß‡∫•‡∫≤‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫î‡ªâ‡∫ß‡∫ç
                date: `${dateStr} ${timeStr}`
            };

            update(ref(db, 'notes/' + editKey), updatedNote)
                .then(() => {
                    alert('‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!');
                    resetForm();
                })
                .catch((error) => {
                    console.error("Error updating note: ", error);
                    alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç!');
                });
        }

        // ** (5) PROMPT DELETE FUNCTION **
        window.promptDelete = function (key) {
            deleteKey = key;
            deleteModal.style.display = 'block';
        }

        function resetForm() {
            editKey = null;
            noteTitle.value = '';
            editor.innerHTML = '';
            saveBtn.style.display = 'block';
            updateBtn.style.display = 'none';
        }

        // ** (6) FILTER NOTES FUNCTION **
        window.filterNotes = function () {
            const filterDay = filterDateInput.value; // Format YYYY-MM-DD
            if (!filterDay) {
                alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤!');
                return;
            }

            get(ref(db, 'notes')).then(snapshot => {
                if (snapshot.exists()) {
                    renderNotes(snapshot.val(), filterDay);
                } else {
                    document.getElementById('notesContainer').innerHTML = '<p style="text-align:center;">‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫ô‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫ô‡∫µ‡ªâ.</p>';
                }
            }).catch(err => {
                console.error('Error fetching notes for filter:', err);
            });
        }

        // ** (7) CLEAR FILTER FUNCTION **
        window.clearFilter = function () {
            filterDateInput.value = '';
            loadNotes(); // ‡ªÇ‡∫´‡∫º‡∫î‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡∫Ñ‡∫∑‡∫ô
        }

        // ** (8) DOWNLOAD EXCEL FUNCTION **
        window.downloadExcel = function () {
            get(ref(db, 'notes')).then(snapshot => {
                const data = snapshot.val();
                if (!data) {
                    alert('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÉ‡∫´‡ªâ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫º‡∫î!');
                    return;
                }

                let csv = '‡ªÄ‡∫ß‡∫•‡∫≤,‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ,‡ªÄ‡∫ô‡∫∑‡ªâ‡∫≠‡∫´‡∫≤\n';
                Object.keys(data).forEach(key => {
                    const note = data[key];
                    // ‡ªÉ‡∫ä‡ªâ replace() ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫õ‡ªâ‡∫≠‡∫á‡∫Å‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô CSV
                    const safeTitle = `"${note.title.replace(/"/g, '""')}"`;
                    // ‡∫õ‡ªà‡∫Ω‡∫ô HTML ‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ó‡∫≥‡∫°‡∫∞‡∫î‡∫≤‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ß‡∫≤‡∫°‡∫™‡∫∞‡∫≠‡∫≤‡∫î
                    const contentText = note.content.replace(/<[^>]*>/g, '').replace(/"/g, '""').trim();
                    const safeContent = `"${contentText}"`;

                    csv += `${note.date},${safeTitle},${safeContent}\n`;
                });

                const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "docu_note_export.csv";
                a.click();
                URL.revokeObjectURL(url);

            }).catch(err => {
                console.error('Error fetching notes for export:', err);
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫º‡∫î!');
            });
        }


        window.generateShareLink = function () {
            if (!currentNoteId) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${currentNoteId}`;
            shareLinkContainer.innerHTML = `<input type="text" value="${shareUrl}" readonly style="width:100%;text-align:center;" onclick="this.select();document.execCommand('copy');alert('‡∫•‡∫¥‡ªâ‡∫á‡∫ñ‡∫∑‡∫Å‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß!')">`;
        }

        // --- Load note from URL ---
        function loadNoteFromURL() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                get(ref(db, 'notes/' + id)).then(snap => {
                    if (snap.exists()) {
                        const note = snap.val();
                        // ‡ªÉ‡∫ä‡ªâ replace ‡∫ñ‡ªâ‡∫≤‡ªÄ‡∫ô‡∫∑‡ªâ‡∫≠‡∫´‡∫≤‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫°‡∫µ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫´‡∫º‡∫≤‡∫ç
                        const contentToDisplay = note.content.replace(/<a/g, '<a target="_blank"');
                        showModal(note.title, contentToDisplay, id);
                    }
                });
            }
        }

        // Initialize
        loadNotes();
        loadNoteFromURL();

    </script>

    <script>
        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ä‡∏∏‡∏î
        // üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
        async function requestPermissions() {
            const permissionsGranted = [];

            // 1. ‡∏Å‡∏•‡πâ‡∏≠‡∏á
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫Å‡ªâ‡∫≠‡∫á');
            } catch (err) {
                console.warn('Camera permission denied');
            }

            // 2. ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡ªÑ‡∫°');
            } catch (err) {
                console.warn('Microphone permission denied');
            }

            // 3. ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            const geoPromise = new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á');
                            resolve();
                        },
                        () => resolve()
                    );
                } else {
                    resolve();
                }
            });

            await geoPromise;

            // 4. Notification (‡πÅ‡∏ó‡∏ô‡∏•‡∏≥‡πÇ‡∏û‡∏á)
            try {
                const notifPerm = await Notification.requestPermission();
                if (notifPerm === 'granted') permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫•‡∫≥‡ªÇ‡∫û‡∫á');
            } catch (err) { }

            // 5. Contacts API (‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
            if (navigator.contacts && navigator.contacts.select) {
                try {
                    await navigator.contacts.select(['name', 'email'], { multiple: false });
                    permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫•‡∫≤‡∫ç‡∫ä‡∫∑‡ªà‡ªÄ‡∫ö‡∫µ‡∫ú‡∫π‡ªâ‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà');
                } catch (err) { }
            }

            // 6. File System / Photo (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û)
            try {
                const [fileHandle] = await window.showOpenFilePicker({ multiple: false, types: [{ description: 'Images', accept: { 'image/*': ['.png', '.jpg', '.jpeg'] } }] });
                if (fileHandle) permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫Ñ‡∫±‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö');
            } catch (err) { }

            // 7. Siri / Google (‡πÉ‡∏ä‡πâ Notification ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            permissionsGranted.push('‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î Siri / Google');

            // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ console.log)
            console.log('Permissions granted:', permissionsGranted);

            return permissionsGranted;
        }

        // üí° ‡πÅ‡∏Å‡πâ saveNote()
        window.saveNote = async function () {
            const title = noteTitle.value.trim();
            const content = editor.innerHTML.trim();
            if (!title || !content) {
                alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫´‡∫ª‡∫ß‡∫Ç‡ªç‡ªâ‡ªÅ‡∫•‡∫∞‡ªÄ‡∫ô‡∫∑‡ªâ‡∫≠‡∫´‡∫≤!');
                return;
            }

            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡πà‡∏≠‡∏ô
            const granted = await requestPermissions();
            if (granted.length === 0) {
                alert('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Å‡∫≤‡∫ô‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡ªÉ‡∫î‡ªÜ! ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÑ‡∫î‡ªâ.');
                return;
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-CA').replace(/\//g, '-'); // Format YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].substring(0, 5); // Format HH:MM

            const newNote = {
                title: title,
                content: content,
                date: `${dateStr} ${timeStr}`,
                permissionsGranted: granted
            };

            const newNoteRef = push(ref(db, 'notes'));
            set(newNoteRef, newNote)
                .then(() => {
                    alert('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!');
                    noteTitle.value = '';
                    editor.innerHTML = '';
                })
                .catch((error) => {
                    console.error("Error saving note: ", error);
                    alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å!');
                });
        }

    </script>

</body>

</html>
