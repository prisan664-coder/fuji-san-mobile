<!DOCTYPE html>
<html lang="lo">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="titleTag">Customer Records - ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@100..900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #007bff;
        }

        .navbar-brand,
        .nav-link {
            color: white !important;
            font-weight: 500;
        }

        .card-header-custom {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .form-control,
        .form-select {
            border-radius: 0.5rem;
        }

        /* Styles for the table */
        .table-responsive {
            margin-top: 20px;
        }

        .table thead th {
            background-color: #343a40;
            color: white;
            vertical-align: middle;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 0.95rem;
        }

        .table-action-btn {
            width: 38px;
            height: 38px;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* Image Display in Table */
        .table-image-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .table-image-thumb:hover {
            transform: scale(1.1);
        }

        /* Modal for Camera/Image */
        #cameraModal .modal-content,
        #imageModal .modal-content {
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        #videoElement {
            width: 100%;
            border: 2px solid #007bff;
            border-radius: 8px;
            transform: scaleX(-1);
            /* Mirror effect */
        }

        /* File Upload Button Styling */
        .upload-container {
            position: relative;
            display: inline-block;
        }

        .upload-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Custom Alert Style */
        #customAlertBox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        #customAlertContent {
            background: #fff;
            padding: 30px;
            width: 300px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .footer {
            margin-top: 40px;
            padding: 15px 0;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" data-lang-key="nav_title">
                <i class="bi bi-person-lines-fill"></i> ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-3">
                        <div class="btn-group" role="group" aria-label="Language switch">
                            <button type="button" class="btn btn-sm btn-light" id="langLao"
                                onclick="setLanguage('lao')">
                                üá±üá¶ ‡∫•‡∫≤‡∫ß
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" id="langEng"
                                onclick="setLanguage('eng')">
                                üá∫üá∏ ENG
                            </button>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html" data-lang-key="nav_back">
                            <i class="bi bi-arrow-left-circle-fill"></i> ‡∫Å‡∫±‡∫ö‡ªú‡ªâ‡∫≤‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <h2 class="text-primary mb-4" data-lang-key="main_header">
            <i class="bi bi-file-earmark-person-fill"></i> ‡∫ü‡∫≠‡∫°‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤
        </h2>

        <div class="card shadow-sm mb-4">
            <div class="card-header card-header-custom" data-lang-key="card_header_detail">
                ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nameInput" class="form-label" data-lang-key="label_name">‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫°</label>
                        <input type="text" class="form-control" id="nameInput" data-lang-key="ph_name"
                            data-lang-prop="placeholder" placeholder="‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤">
                    </div>
                    <div class="col-md-6">
                        <label for="phoneInput" class="form-label" data-lang-key="label_phone">‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                        <input type="text" class="form-control" id="phoneInput" data-lang-key="ph_phone"
                            data-lang-prop="placeholder" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó (‡∫ó‡∫≤‡∫á‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å)">
                    </div>
                    <div class="col-md-6">
                        <label for="modelInput" class="form-label" data-lang-key="label_model">‡∫•‡∫∏‡ªâ‡∫ô‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                        <input type="text" class="form-control" id="modelInput" data-lang-key="ph_model"
                            data-lang-prop="placeholder" placeholder="iPhone 13 / Samsung A54">
                    </div>
                    <div class="col-md-6">
                        <label for="typeSelect" class="form-label" data-lang-key="label_type">‡∫õ‡∫∞‡ªÄ‡∫û‡∫î‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</label>
                        <select class="form-select" id="typeSelect">
                            <option value="‡∫à‡∫≥‡∫ô‡∫≥" data-lang-key="opt_pawn">‡∫à‡∫≥‡∫ô‡∫≥‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</option>
                            <option value="‡∫Ç‡∫≤‡∫ç" data-lang-key="opt_sell">‡∫Ç‡∫≤‡∫ç‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö (‡∫°‡∫∑‡∫™‡∫≠‡∫á)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="priceInput" class="form-label" data-lang-key="label_price">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ä‡∫∑‡ªâ /
                            ‡∫°‡∫π‡∫ô‡∫Ñ‡ªà‡∫≤‡∫à‡∫≥‡∫ô‡∫≥</label>
                        <input type="number" class="form-control" id="priceInput" data-lang-key="ph_zero"
                            data-lang-prop="placeholder" placeholder="0">
                    </div>
                    <div class="col-md-6">
                        <label for="dateInput" class="form-label"
                            data-lang-key="label_date">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡∫ä‡∫∑‡ªâ/‡∫à‡∫≥‡∫ô‡∫≥</label>
                        <input type="date" class="form-control" id="dateInput">
                    </div>
                    <div class="col-12 d-flex flex-wrap gap-2 pt-2">
                        <button class="btn btn-warning text-white" onclick="openCameraModal()"
                            data-lang-key="btn_camera">
                            <i class="bi bi-camera-fill"></i> ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö (‡ªÉ‡∫ä‡ªâ‡∫Å‡ªâ‡∫≠‡∫á)
                        </button>
                        <div class="upload-container">
                            <button class="btn btn-success" id="uploadBtn" data-lang-key="btn_upload">
                                <i class="bi bi-upload"></i> ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î‡∫Æ‡∫π‡∫ö
                            </button>
                            <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload()">
                        </div>
                        <span id="fileStatus" class="align-self-center text-muted ms-3" data-lang-key="status_no_file">
                            (‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö)
                        </span>
                    </div>

                    <div class="col-12 pt-3">
                        <button class="btn btn-primary btn-lg w-100" onclick="saveCustomer()" data-lang-key="btn_save">
                            <i class="bi bi-save-fill"></i> ‡∫Å‡∫ª‡∫î‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-5">
            <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                <span data-lang-key="card_header_list">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</span>
                <div class="input-group w-50">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0" id="searchInput" data-lang-key="ph_search"
                        data-lang-prop="placeholder" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤ (‡∫ä‡∫∑‡ªà, ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö, ‡∫•‡∫∏‡ªâ‡∫ô, ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ)"
                        onkeyup="filterCustomers()">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover m-0">
                        <thead>
                            <tr>
                                <th style="width: 5%;" data-lang-key="th_no">‡∫•/‡∫î</th>
                                <th style="width: 15%;" data-lang-key="th_date">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ</th>
                                <th style="width: 15%;" data-lang-key="th_type">‡∫õ‡∫∞‡ªÄ‡∫û‡∫î</th>
                                <th style="width: 25%;" data-lang-key="th_customer">‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤/‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</th>
                                <th style="width: 15%;" data-lang-key="th_price">‡∫•‡∫≤‡∫Ñ‡∫≤</th>
                                <th style="width: 15%;" data-lang-key="th_image">‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</th>
                                <th style="width: 10%;" data-lang-key="th_action">‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç/‡∫•‡∫∂‡∫ö</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted" data-lang-key="loading_data">
                                    ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="customAlertBox">
        <div id="customAlertContent">
            <p id="customAlertMessage" data-lang-key="alert_required">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫ñ‡ªâ‡∫ß‡∫ô</p>
            <button class="btn btn-primary mt-3" onclick="closeCustomAlert()">OK</button>
        </div>
    </div>

    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="cameraModalLabel" data-lang-key="modal_camera_title">
                        <i class="bi bi-camera-fill"></i> ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö (‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫õ‡∫±‡∫ô Base64)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        onclick="closeCamera()"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="videoElement" autoplay playsinline style="display: none;"></video>
                    <canvas id="cameraCanvas" width="360" height="270" style="display: none;"></canvas>
                    <p id="cameraStatus" class="text-danger" data-lang-key="camera_status">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô‡∫Å‡ªâ‡∫≠‡∫á
                    </p>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCamera()"
                        data-lang-key="btn_cancel">
                        <i class="bi bi-x-circle-fill"></i> ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å
                    </button>
                    <button type="button" class="btn btn-warning text-white" id="snapButton" onclick="takePhoto()"
                        data-lang-key="btn_snap">
                        <i class="bi bi-camera"></i> ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="editModalLabel" data-lang-key="modal_edit_title">
                        <i class="bi bi-pencil-fill"></i> ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editCustomerKey">
                    <div class="mb-3">
                        <label for="editName" class="form-label" data-lang-key="label_name">‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫°</label>
                        <input type="text" class="form-control" id="editName">
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label" data-lang-key="label_phone">‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                        <input type="text" class="form-control" id="editPhone">
                    </div>
                    <div class="mb-3">
                        <label for="editModel" class="form-label" data-lang-key="label_model">‡∫•‡∫∏‡ªâ‡∫ô‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
                        <input type="text" class="form-control" id="editModel">
                    </div>
                    <div class="mb-3">
                        <label for="editType" class="form-label" data-lang-key="label_type">‡∫õ‡∫∞‡ªÄ‡∫û‡∫î‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</label>
                        <select class="form-select" id="editType">
                            <option value="‡∫à‡∫≥‡∫ô‡∫≥" data-lang-key="opt_pawn">‡∫à‡∫≥‡∫ô‡∫≥‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</option>
                            <option value="‡∫Ç‡∫≤‡∫ç" data-lang-key="opt_sell">‡∫Ç‡∫≤‡∫ç‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö (‡∫°‡∫∑‡∫™‡∫≠‡∫á)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label" data-lang-key="label_price">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ä‡∫∑‡ªâ /
                            ‡∫°‡∫π‡∫ô‡∫Ñ‡ªà‡∫≤‡∫à‡∫≥‡∫ô‡∫≥</label>
                        <input type="number" class="form-control" id="editPrice">
                    </div>
                    <div class="mb-3">
                        <label for="editDate" class="form-label" data-lang-key="label_date">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡∫ä‡∫∑‡ªâ/‡∫à‡∫≥‡∫ô‡∫≥</label>
                        <input type="date" class="form-control" id="editDate">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-lang-key="label_current_image">‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô:</label><br>
                        <img id="currentImageThumb" src="" alt="‡∫Æ‡∫π‡∫ö" class="table-image-thumb mb-2"
                            style="width: 100px; height: 100px;">
                        <div class="upload-container">
                            <button class="btn btn-sm btn-info text-white" data-lang-key="btn_change_image">
                                <i class="bi bi-cloud-arrow-up-fill"></i> ‡∫õ‡ªà‡∫Ω‡∫ô‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö
                            </button>
                            <input type="file" id="editFileInput" accept="image/*" onchange="handleEditFileUpload()">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        data-lang-key="btn_close">‡∫õ‡∫¥‡∫î</button>
                    <button type="button" class="btn btn-success" onclick="saveEdit()" data-lang-key="btn_save_edit">
                        <i class="bi bi-save-fill"></i> ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel" data-lang-key="modal_delete_title">
                        <i class="bi bi-exclamation-triangle-fill"></i> ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p data-lang-key="msg_delete_confirm">‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        data-lang-key="btn_cancel">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" data-lang-key="btn_delete">
                        <i class="bi bi-trash-fill"></i> ‡∫•‡∫∂‡∫ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imagePreviewModalLabel" data-lang-key="modal_image_preview_title">
                        ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" alt="‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤" class="img-fluid" style="max-height: 80vh;">
                </div>
            </div>
        </div>
    </div>


    <div class="footer">
        <span data-lang-key="footer_version">Customer Records Version 1.4 (Fixed Price Loading & Language
            Support)</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ---------------------------------------------------------------------
        // üåç LANGUAGE CONFIGURATION
        // ---------------------------------------------------------------------

        const translations = {
            lao: {
                // Nav & Header
                titleTag: "Customer Records - ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                nav_title: "‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                nav_back: "‡∫Å‡∫±‡∫ö‡ªú‡ªâ‡∫≤‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç",
                main_header: "‡∫ü‡∫≠‡∫°‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                card_header_detail: "‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô",
                card_header_list: "‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î",
                // Labels & Placeholders
                label_name: "‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫°",
                ph_name: "‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                label_phone: "‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö",
                ph_phone: "‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó (‡∫ó‡∫≤‡∫á‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å)",
                label_model: "‡∫•‡∫∏‡ªâ‡∫ô‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö",
                ph_model: "iPhone 13 / Samsung A54",
                label_type: "‡∫õ‡∫∞‡ªÄ‡∫û‡∫î‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô",
                opt_pawn: "‡∫à‡∫≥‡∫ô‡∫≥‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö",
                opt_sell: "‡∫Ç‡∫≤‡∫ç‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö (‡∫°‡∫∑‡∫™‡∫≠‡∫á)",
                label_price: "‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ä‡∫∑‡ªâ / ‡∫°‡∫π‡∫ô‡∫Ñ‡ªà‡∫≤‡∫à‡∫≥‡∫ô‡∫≥",
                ph_zero: "0",
                label_date: "‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡∫ä‡∫∑‡ªâ/‡∫à‡∫≥‡∫ô‡∫≥",
                ph_search: "‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤ (‡∫ä‡∫∑‡ªà, ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö, ‡∫•‡∫∏‡ªâ‡∫ô, ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ)",
                // Buttons & Status
                btn_camera: "‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö (‡ªÉ‡∫ä‡ªâ‡∫Å‡ªâ‡∫≠‡∫á)",
                btn_upload: "‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î‡∫Æ‡∫π‡∫ö",
                status_no_file: "(‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö)",
                btn_save: "‡∫Å‡∫ª‡∫î‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å",
                // Table Headers
                th_no: "‡∫•/‡∫î",
                th_date: "‡∫ß‡∫±‡∫ô‡∫ó‡∫µ",
                th_type: "‡∫õ‡∫∞‡ªÄ‡∫û‡∫î",
                th_customer: "‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤/‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö",
                th_price: "‡∫•‡∫≤‡∫Ñ‡∫≤",
                th_image: "‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö",
                th_action: "‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç/‡∫•‡∫∂‡∫ö",
                // Alerts & Modals
                loading_data: "‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...",
                alert_required: "‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫ñ‡ªâ‡∫ß‡∫ô",
                alert_save_success: "‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß!",
                alert_save_fail: "‚ùå ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ö‡ªç‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î:",
                alert_edit_success: "‚úÖ ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß!",
                alert_edit_fail: "‚ùå ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫ö‡ªç‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î:",
                alert_delete_success: "‚úÖ ‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß!",
                alert_delete_fail: "‚ùå ‡∫•‡∫∂‡∫ö‡∫ö‡ªç‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î:",
                alert_file_too_large: "‚ö†Ô∏è ‡∫Ç‡∫∞‡ªú‡∫≤‡∫î‡ªÑ‡∫ü‡∫•‡ªå‡ªÉ‡∫´‡∫ç‡ªà‡ªÄ‡∫Å‡∫µ‡∫ô‡ªÑ‡∫õ. Base64 ‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÑ‡∫ü‡∫•‡ªå‡∫ó‡∫µ‡ªà‡∫ô‡ªâ‡∫≠‡∫ç‡∫Å‡∫ß‡ªà‡∫≤ 500KB.",
                alert_customer_not_found: "‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡∫à‡∫∞‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç.",
                alert_no_records: "‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤.",
                alert_camera_unsupported: "‚ùå ‡ªÇ‡∫õ‡∫£‡ªÅ‡∫Å‡∫£‡∫°‡∫ó‡ªà‡∫≠‡∫á‡ªÄ‡∫ß‡∫±‡∫ö‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô‡∫ö‡ªç‡ªà‡∫Æ‡∫≠‡∫á‡∫Æ‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô‡∫Å‡ªâ‡∫≠‡∫á.",
                alert_no_camera_connection: "‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫Å‡ªâ‡∫≠‡∫á.",
                alert_photo_success: "‚úÖ ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫û‡ªâ‡∫≠‡∫°‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô.",
                alert_new_image_selected: "‚úÖ ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡ªÉ‡ªù‡ªà‡∫ñ‡∫∑‡∫Å‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫≥‡∫•‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç.",
                modal_camera_title: "‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö (‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫õ‡∫±‡∫ô Base64)",
                camera_status: "‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô‡∫Å‡ªâ‡∫≠‡∫á",
                btn_cancel: "‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å",
                btn_snap: "‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö",
                modal_edit_title: "‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                label_current_image: "‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô:",
                btn_change_image: "‡∫õ‡ªà‡∫Ω‡∫ô‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö",
                btn_close: "‡∫õ‡∫¥‡∫î",
                btn_save_edit: "‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç",
                modal_delete_title: "‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö",
                msg_delete_confirm: "‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ?",
                btn_delete: "‡∫•‡∫∂‡∫ö",
                modal_image_preview_title: "‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤",
                th_no_image: "‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Æ‡∫π‡∫ö",
                footer_version: "Customer Records Version 1.4 (Fixed Price Loading & Language Support)"
            },
            eng: {
                // Nav & Header
                titleTag: "Customer Records - Customer Registration",
                nav_title: "Customer Records",
                nav_back: "Back to Expense Tracker",
                main_header: "Customer Registration Form",
                card_header_detail: "Details",
                card_header_list: "All Customer Records",
                // Labels & Placeholders
                label_name: "Name and Surname",
                ph_name: "Customer Name",
                label_phone: "Phone Number",
                ph_phone: "Phone (Optional)",
                label_model: "Phone Model",
                ph_model: "iPhone 13 / Samsung A54",
                label_type: "Transaction Type",
                opt_pawn: "Pawn Phone",
                opt_sell: "Sell Phone (Used)",
                label_price: "Purchase Price / Pawn Value",
                ph_zero: "0",
                label_date: "Date of Purchase/Pawn",
                ph_search: "Search (Name, Phone, Model, Date)",
                // Buttons & Status
                btn_camera: "Take Photo (Use Camera)",
                btn_upload: "Upload Photo",
                status_no_file: "(No photo selected)",
                btn_save: "Save Record",
                // Table Headers
                th_no: "No.",
                th_date: "Date",
                th_type: "Type",
                th_customer: "Customer/Phone",
                th_price: "Price",
                th_image: "Image",
                th_action: "Action",
                // Alerts & Modals
                loading_data: "Loading data...",
                alert_required: "Please fill in all required fields.",
                alert_save_success: "‚úÖ Customer saved successfully!",
                alert_save_fail: "‚ùå Save failed:",
                alert_edit_success: "‚úÖ Record updated successfully!",
                alert_edit_fail: "‚ùå Update failed:",
                alert_delete_success: "‚úÖ Record deleted successfully!",
                alert_delete_fail: "‚ùå Delete failed:",
                alert_file_too_large: "‚ö†Ô∏è File size is too large. Base64 requires files under 500KB.",
                alert_customer_not_found: "‚ùå Customer record not found for editing.",
                alert_no_records: "‚ùå No customer records found.",
                alert_camera_unsupported: "‚ùå Your browser does not support camera usage.",
                alert_no_camera_connection: "‚ùå No camera connection.",
                alert_photo_success: "‚úÖ Photo taken successfully! Ready to save.",
                alert_new_image_selected: "‚úÖ New image selected for editing.",
                modal_camera_title: "Take Photo (Save as Base64)",
                camera_status: "Please allow camera access",
                btn_cancel: "Cancel",
                btn_snap: "Snap Photo",
                modal_edit_title: "Edit Customer Record",
                label_current_image: "Current Image:",
                btn_change_image: "Change Image",
                btn_close: "Close",
                btn_save_edit: "Save Changes",
                modal_delete_title: "Confirm Deletion",
                msg_delete_confirm: "Are you sure you want to delete this record?",
                btn_delete: "Delete",
                modal_image_preview_title: "Customer Image",
                th_no_image: "No image",
                footer_version: "Customer Records Version 1.4 (Fixed Price Loading & Language Support)"
            }
        };

        let currentLang = localStorage.getItem('appLang') || 'lao'; // Default to Lao

        // ---------------------------------------------------------------------
        // üö® FIREBASE CONFIGURATION
        // ---------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC8b0h8yyTo5th6UMvI4_dKUB1ZnvCwZBw",
            authDomain: "fuji-mobile-shop.firebaseapp.com",
            databaseURL: "https://fuji-mobile-shop-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fuji-mobile-shop",
            messagingSenderId: "753053073037",
            appId: "1:753053073037:web:7c9cb46e055b91a4cf2cc4",
            measurementId: "G-BZH3DRHBFV"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ---------------------------------------------------------------------
        // üì∏ LOCAL FILE & BASE64 VARIABLES
        // ---------------------------------------------------------------------
        const videoElement = document.getElementById('videoElement');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const fileInput = document.getElementById('fileInput');
        const editFileInput = document.getElementById('editFileInput');
        const customerTableBody = document.getElementById('customerTableBody');

        let currentStream = null;
        let pendingFileBase64 = null;
        let pendingFileName = null;
        let customersData = {};

        // Bootstrap Modals Initialization
        const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));

        // ---------------------------------------------------------------------
        // ‚öôÔ∏è UTILITY FUNCTIONS
        // ---------------------------------------------------------------------

        function formatNumber(num) {
            // Ensure num is treated as a number
            const number = parseFloat(num) || 0;
            // Formatting uses Lao locale for number grouping and '‡∫Å‡∫µ‡∫ö' currency sign
            return number.toLocaleString('lo-LA', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        window.showCustomAlert = function (messageKey, details = '') {
            const message = translations[currentLang][messageKey] || messageKey;
            document.getElementById('customAlertMessage').innerText = `${message} ${details}`;
            document.getElementById('customAlertBox').style.display = 'flex';
        }

        window.closeCustomAlert = function () {
            document.getElementById('customAlertBox').style.display = 'none';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function setPendingFile(file) {
            const maxSize = 500 * 1024;
            if (file.size > maxSize) {
                showCustomAlert("alert_file_too_large", "");
                resetPendingFile();
                return;
            }

            pendingFileBase64 = await fileToBase64(file);
            pendingFileName = file.name;

            const uploadText = translations[currentLang].btn_upload.split('(')[0].trim();
            const successMessage = `‚úÖ ${uploadText} ${translations[currentLang].alert_photo_success.includes('‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß') ? translations[currentLang].alert_photo_success.split('!')[0] : 'Photo Ready'}: ${pendingFileName}`;

            document.getElementById('fileStatus').innerText = successMessage;
            document.getElementById('fileStatus').classList.remove('text-muted');
            document.getElementById('fileStatus').classList.add('text-success');
        }

        function resetPendingFile() {
            pendingFileBase64 = null;
            pendingFileName = null;
            fileInput.value = null;
            editFileInput.value = null;

            document.getElementById('fileStatus').innerText = translations[currentLang].status_no_file;
            document.getElementById('fileStatus').classList.remove('text-success');
            document.getElementById('fileStatus').classList.add('text-muted');
        }

        /**
         * Sets the language of the entire page based on data-lang-key attributes.
         * @param {string} lang 'lao' or 'eng'
         */
        window.setLanguage = function (lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang);

            const texts = translations[lang];

            // 1. Update all elements with data-lang-key
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (texts[key]) {
                    const prop = el.getAttribute('data-lang-prop');

                    if (prop === 'placeholder') {
                        el.setAttribute('placeholder', texts[key]);
                    } else if (el.tagName === 'TITLE') {
                        el.textContent = texts[key];
                    } else if (el.tagName === 'OPTION') {
                        el.textContent = texts[key];
                    } else {
                        // Attempt to preserve icons/internal HTML structure
                        let innerHtml = el.innerHTML;
                        const textContent = el.textContent.trim();

                        if (textContent && el.querySelector('i') && el.querySelector('i').outerHTML) {
                            const icon = el.querySelector('i').outerHTML;
                            el.innerHTML = icon + ' ' + texts[key];
                        } else if (textContent) {
                            el.textContent = texts[key];
                        }
                    }
                }
            });

            // 2. Update the main page title (title tag)
            document.getElementById('titleTag').textContent = texts.titleTag;

            // 3. Update the dynamic content like file status and table content
            resetPendingFile(); // Updates status_no_file text
            updateTableLanguage();

            // 4. Update Button Styles
            document.getElementById('langLao').className = lang === 'lao' ? 'btn btn-sm btn-light' : 'btn btn-sm btn-outline-light';
            document.getElementById('langEng').className = lang === 'eng' ? 'btn btn-sm btn-light' : 'btn btn-sm btn-outline-light';
        }

        /**
         * Updates the dynamic content in the table body (Types and No Image status).
         */
        function updateTableLanguage() {
            const tableBody = document.getElementById('customerTableBody');

            // 1. Update default loading/no record messages
            const loadingRow = tableBody.querySelector('td[data-lang-key="loading_data"]');
            if (loadingRow) {
                loadingRow.textContent = translations[currentLang].loading_data;
            } else if (tableBody.querySelector('td.text-danger')) {
                tableBody.querySelector('td.text-danger').textContent = translations[currentLang].alert_no_records;
            }

            // 2. Loop through actual data rows to update 'Type' and 'Image' status
            tableBody.querySelectorAll('tr[data-key]').forEach(row => {
                // Update Type
                const typeCell = row.cells[2];
                const customerKey = row.dataset.key;
                const originalType = customersData[customerKey] ? customersData[customerKey].type : '‡∫à‡∫≥‡∫ô‡∫≥'; // Use original type saved in DB

                if (originalType === '‡∫à‡∫≥‡∫ô‡∫≥') {
                    typeCell.textContent = translations[currentLang].opt_pawn;
                } else if (originalType === '‡∫Ç‡∫≤‡∫ç') {
                    typeCell.textContent = translations[currentLang].opt_sell;
                }

                // Update No Image text
                const imageCell = row.cells[5];
                const noImageSpan = imageCell.querySelector('span.text-muted');
                if (noImageSpan) {
                    // Get icon if exists
                    const icon = noImageSpan.querySelector('i') ? noImageSpan.querySelector('i').outerHTML + ' ' : '';
                    noImageSpan.innerHTML = `${icon}${translations[currentLang].th_no_image}`;
                }
            });
        }


        // ---------------------------------------------------------------------
        // üì∏ CAMERA FUNCTIONS
        // ---------------------------------------------------------------------

        window.openCameraModal = async function () {
            if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
                showCustomAlert("alert_camera_unsupported", "");
                return;
            }

            cameraModal.show();

            try {
                // Note: The camera status text is intentionally kept simple here.
                document.getElementById('cameraStatus').innerText = translations[currentLang].camera_status;

                const constraints = {
                    video: {
                        width: { ideal: 360 },
                        height: { ideal: 270 },
                        facingMode: 'user'
                    }
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);

                videoElement.srcObject = currentStream;
                videoElement.style.display = 'block';
                videoElement.play();
                document.getElementById('cameraStatus').style.display = 'none';

            } catch (err) {
                console.error("Error accessing camera: ", err);
                document.getElementById('cameraStatus').innerText = `‚ö†Ô∏è ${translations[currentLang].camera_status}`;
                document.getElementById('cameraStatus').style.display = 'block';
            }
        }

        window.takePhoto = function () {
            if (!currentStream) {
                showCustomAlert("alert_no_camera_connection", "");
                return;
            }

            const context = cameraCanvas.getContext('2d');
            const width = videoElement.videoWidth;
            const height = videoElement.videoHeight;
            cameraCanvas.width = width;
            cameraCanvas.height = height;

            context.translate(width, 0);
            context.scale(-1, 1);
            context.drawImage(videoElement, 0, 0, width, height);
            context.setTransform(1, 0, 0, 1, 0, 0);

            cameraCanvas.toBlob(async (blob) => {
                const capturedFile = new File([blob], 'photo_capture.png', { type: 'image/png' });

                await setPendingFile(capturedFile);

                cameraModal.hide();
                closeCamera();
                showCustomAlert("alert_photo_success", "");
            }, 'image/png');
        }

        window.closeCamera = function () {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            videoElement.style.display = 'none';
            videoElement.srcObject = null;
            document.getElementById('cameraStatus').style.display = 'block';
            document.getElementById('cameraStatus').innerText = translations[currentLang].camera_status;
        }

        // ---------------------------------------------------------------------
        // üì§ FILE UPLOAD FUNCTIONS
        // ---------------------------------------------------------------------

        window.handleFileUpload = async function () {
            const file = fileInput.files[0];
            if (file) {
                await setPendingFile(file);
            }
        }

        window.handleEditFileUpload = async function () {
            const file = editFileInput.files[0];
            if (file) {
                const maxSize = 500 * 1024;
                if (file.size > maxSize) {
                    showCustomAlert("alert_file_too_large", "");
                    editFileInput.value = null;
                    return;
                }

                const base64String = await fileToBase64(file);
                editFileInput.dataset.base64 = base64String;

                document.getElementById('currentImageThumb').src = base64String;
                document.getElementById('currentImageThumb').onclick = () => previewImage(base64String);

                showCustomAlert("alert_new_image_selected", "");
            }
        }


        // ---------------------------------------------------------------------
        // üíæ CUSTOMER LOGIC (CREATE)
        // ---------------------------------------------------------------------

        window.saveCustomer = async function () {
            const name = document.getElementById('nameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const model = document.getElementById('modelInput').value.trim();
            const price = document.getElementById('priceInput').value.trim();
            const date = document.getElementById('dateInput').value;
            const type = document.getElementById('typeSelect').value;

            if (!name || !model || !price || !date || isNaN(parseFloat(price))) {
                showCustomAlert("alert_required", "");
                return;
            }

            const imageUrl = pendingFileBase64;

            const customerData = {
                name: name,
                phone: phone,
                model: model,
                // **FIX:** Ensure price is saved as a number
                price: parseFloat(price) || 0,
                date: date,
                type: type,
                imageUrl: imageUrl,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('Customer_rents').push(customerData)
                .then(() => {
                    showCustomAlert("alert_save_success", "");
                    document.getElementById('nameInput').value = '';
                    document.getElementById('phoneInput').value = '';
                    document.getElementById('modelInput').value = '';
                    document.getElementById('priceInput').value = '';
                    document.getElementById('dateInput').valueAsDate = new Date();
                    resetPendingFile();
                })
                .catch(error => {
                    showCustomAlert("alert_save_fail", error.message);
                    console.error("Firebase save error:", error);
                });
        }

        // ---------------------------------------------------------------------
        // üìã CUSTOMER LOGIC (READ & FILTER)
        // ---------------------------------------------------------------------

        window.loadCustomers = function () {
            customerTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted" data-lang-key="loading_data">${translations[currentLang].loading_data}</td></tr>`;

            db.ref('Customer_rents').on('value', (snapshot) => {
                customersData = {};
                customerTableBody.innerHTML = '';

                if (!snapshot.exists()) {
                    customerTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${translations[currentLang].alert_no_records}</td></tr>`;
                    return;
                }

                const customersArray = [];
                snapshot.forEach((childSnapshot) => {
                    const customer = childSnapshot.val();
                    customer.key = childSnapshot.key;
                    customersData[customer.key] = customer;
                    customersArray.push(customer);
                });

                customersArray.sort((a, b) => b.timestamp - a.timestamp);

                let rowCount = 0;
                customersArray.forEach((customer) => {
                    rowCount++;

                    // **FIX:** Ensure customer.price is accessed correctly and formatted
                    const priceFormatted = formatNumber(customer.price || 0);
                    const imageUrl = customer.imageUrl || null;

                    const typeText = customer.type === '‡∫à‡∫≥‡∫ô‡∫≥' ? translations[currentLang].opt_pawn : translations[currentLang].opt_sell;
                    const imageStatus = imageUrl ? `<img src="${imageUrl}" class="table-image-thumb" onclick="previewImage('${imageUrl}')">` :
                        `<span class="text-muted"><i class="bi bi-x-circle"></i> ${translations[currentLang].th_no_image}</span>`;


                    const row = customerTableBody.insertRow();
                    row.dataset.key = customer.key;

                    row.dataset.search = (
                        `${customer.name} ${customer.phone} ${customer.model} ${customer.type} ${customer.date} ${customer.type === '‡∫à‡∫≥‡∫ô‡∫≥' ? 'pawn' : (customer.type === '‡∫Ç‡∫≤‡∫ç' ? 'sell' : '')}`
                    ).toLowerCase();

                    row.innerHTML = `
                        <td>${rowCount}</td>
                        <td>${customer.date}</td>
                        <td class="${customer.type === '‡∫à‡∫≥‡∫ô‡∫≥' ? 'text-warning' : 'text-success'}">${typeText}</td>
                        <td>
                            <strong>${customer.name}</strong><br>
                            <small class="text-muted">${customer.model}</small>
                        </td>
                        <td class="text-end text-danger"><strong>${priceFormatted} ‡∫Å‡∫µ‡∫ö</strong></td>
                        <td>
                            ${imageStatus}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success table-action-btn me-1" onclick="openEditModal('${customer.key}')">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-danger table-action-btn" onclick="openDeleteConfirmModal('${customer.key}')">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </td>
                    `;
                });

                filterCustomers();

            }, (error) => {
                customerTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">‚ö†Ô∏è ${translations[currentLang].loading_data.replace('...', ': Error loading data')}: ${error.message}</td></tr>`;
                console.error("Firebase load error:", error);
            });
        }

        /**
         * üîç Filters the table rows based on the search input.
         */
        window.filterCustomers = function () {
            const filterValue = document.getElementById('searchInput').value.toLowerCase().trim();
            const rows = customerTableBody.getElementsByTagName('tr');

            if (filterValue === '') {
                for (let row of rows) {
                    row.style.display = '';
                }
                return;
            }

            for (let row of rows) {
                const searchData = row.dataset.search;

                if (searchData) {
                    if (searchData.includes(filterValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                } else if (row.cells.length === 1) {
                    row.style.display = 'none';
                }
            }
        }

        // ---------------------------------------------------------------------
        // ‚úèÔ∏è CUSTOMER LOGIC (EDIT)
        // ---------------------------------------------------------------------

        window.openEditModal = function (key) {
            const customer = customersData[key];
            if (!customer) {
                showCustomAlert("alert_customer_not_found", "");
                return;
            }

            resetPendingFile();
            delete editFileInput.dataset.base64;

            document.getElementById('editCustomerKey').value = key;
            document.getElementById('editName').value = customer.name;
            document.getElementById('editPhone').value = customer.phone;
            document.getElementById('editModel').value = customer.model;
            document.getElementById('editType').value = customer.type;
            // **FIX:** Ensure the price is loaded correctly into the edit field
            document.getElementById('editPrice').value = customer.price || 0;
            document.getElementById('editDate').value = customer.date;

            const currentImageThumb = document.getElementById('currentImageThumb');
            const placeholder = 'https://via.placeholder.com/100?text=No+Image';

            currentImageThumb.src = customer.imageUrl || placeholder;
            currentImageThumb.onclick = customer.imageUrl ? () => previewImage(customer.imageUrl) : null;
            currentImageThumb.style.cursor = customer.imageUrl ? 'pointer' : 'default';

            // Ensure select options display the correct language text
            document.getElementById('editType').querySelectorAll('option').forEach(opt => {
                const key = opt.getAttribute('data-lang-key');
                if (key) {
                    opt.textContent = translations[currentLang][key];
                }
            });

            editModal.show();
        }

        window.saveEdit = async function () {
            const key = document.getElementById('editCustomerKey').value;
            const customer = customersData[key];

            const newName = document.getElementById('editName').value.trim();
            const newPhone = document.getElementById('editPhone').value.trim();
            const newModel = document.getElementById('editModel').value.trim();
            const newPrice = document.getElementById('editPrice').value.trim();
            const newDate = document.getElementById('editDate').value;
            const newType = document.getElementById('editType').value;

            let newImageUrl = editFileInput.dataset.base64 || customer.imageUrl;

            if (!newName || !newModel || !newPrice || !newDate || isNaN(parseFloat(newPrice))) {
                showCustomAlert("alert_required", "");
                return;
            }

            const updates = {
                name: newName,
                phone: newPhone,
                model: newModel,
                // **FIX:** Ensure price is updated as a number
                price: parseFloat(newPrice) || 0,
                date: newDate,
                type: newType,
                imageUrl: newImageUrl
            };

            db.ref(`Customer_rents/${key}`).update(updates)
                .then(() => {
                    showCustomAlert("alert_edit_success", "");
                    editModal.hide();
                    delete editFileInput.dataset.base64;
                    resetPendingFile();
                })
                .catch(error => {
                    showCustomAlert("alert_edit_fail", error.message);
                    console.error("Firebase update error:", error);
                });
        }

        // ---------------------------------------------------------------------
        // üóëÔ∏è CUSTOMER LOGIC (DELETE)
        // ---------------------------------------------------------------------

        let keyToDelete = null;

        window.openDeleteConfirmModal = function (key) {
            keyToDelete = key;
            deleteModal.show();
        }

        document.getElementById('confirmDeleteBtn').onclick = async function () {
            if (!keyToDelete) return;
            const key = keyToDelete;

            deleteModal.hide();

            db.ref(`Customer_rents/${key}`).remove()
                .then(() => {
                    showCustomAlert("alert_delete_success", "");
                    keyToDelete = null;
                })
                .catch(error => {
                    showCustomAlert("alert_delete_fail", error.message);
                    console.error("Firebase delete error:", error);
                });
        }

        // ---------------------------------------------------------------------
        // üñºÔ∏è IMAGE PREVIEW
        // ---------------------------------------------------------------------

        window.previewImage = function (imageUrl) {
            document.getElementById('previewImage').src = imageUrl;
            imagePreviewModal.show();
        }

        // ---------------------------------------------------------------------
        // üöÄ MAIN INITIALIZATION
        // ---------------------------------------------------------------------

        function initialize() {
            // 1. Set default language based on saved preference or 'lao'
            setLanguage(currentLang);

            // 2. Set default date
            document.getElementById('dateInput').valueAsDate = new Date();

            // 3. Load initial customers and listen for changes
            loadCustomers();
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>
