<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Summary - Fuji Mobile Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }

        .card-summary {
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(20, 20, 50, 0.06);
            padding: 20px;
            margin-top: 20px;
        }

        .table-fixed tbody {
            height: 500px;
            overflow-y: auto;
            display: block;
        }

        .table-fixed thead,
        .table-fixed tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">Fuji Mobile Shop</a>
            <div class="ms-auto">
                <a class="btn btn-outline-secondary" href="record_sale.html">Record Sale</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="card-summary">
            <h4>สรุปยอดขาย</h4>
            <input id="search" class="form-control mb-3" placeholder="ค้นหา Model หรือ วันที่">
            <div class="table-responsive">
                <table class="table table-hover table-fixed">
                    <thead class="table-light">
                        <tr>
                            <th>วันที่</th>
                            <th>Model</th>
                            <th>ราคาขาย (Kip)</th>
                            <th>จำนวน</th>
                            <th>ยอดรวม (Kip)</th>
                            <th>หมายเหตุ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            databaseURL: "https://fuji-mobile-shop-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const salesRef = ref(db, 'sales');
        const productsRef = ref(db, 'products');
        const salesBody = document.getElementById('salesBody');
        let productsData = {};
        let salesData = {};

        onValue(productsRef, (snapshot) => { productsData = snapshot.val() || {}; renderSales(salesData); });
        onValue(salesRef, (snapshot) => { salesData = snapshot.val() || {}; renderSales(salesData); });

        function renderSales(data) {
            salesBody.innerHTML = '';
            const q = document.getElementById('search').value.toLowerCase();
            const keys = Object.keys(data).sort((a, b) => b.localeCompare(a));
            keys.forEach(k => {
                const s = data[k];
                const modelName = productsData[s.product_id]?.name || s.product_id;
                const text = (modelName + ' ' + s.date).toLowerCase();
                if (q && !text.includes(q)) return;
                const tr = document.createElement('tr');
                const total = (Number(s.price) || 0) * (Number(s.qty) || 0);
                tr.innerHTML = `
                    <td>${s.date}</td>
                    <td>${modelName}</td>
                    <td>${Number(s.price).toLocaleString()}</td>
                    <td>${s.qty}</td>
                    <td>${total.toLocaleString()}</td>
                    <td>${s.note || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editSale('${k}')">แก้ไข</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSale('${k}')">ลบ</button>
                    </td>
                `;
                salesBody.appendChild(tr);
            });
        }

        document.getElementById('search').addEventListener('input', () => { renderSales(salesData); });

        window.deleteSale = async function (id) {
            if (confirm('ต้องการลบรายการขายนี้หรือไม่?')) {
                await remove(ref(db, `sales/${id}`));
            }
        };

        window.editSale = function (id) {
            alert('ฟังก์ชันแก้ไขยังไม่ได้ถูกกำหนด');
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>